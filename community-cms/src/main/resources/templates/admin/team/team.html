<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Управление командой проекта - Админ панель</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        .team-management-container {
            max-width: 1200px;
            margin: 0 auto;
            padding-left: 20px;
            padding-right: 20px;
        }
        .team-list-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }
        .team-member-card {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .team-member-card:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .team-member-card.selected {
            background-color: #e7f1ff;
            border-color: #0d6efd;
        }
        .transfer-buttons {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid team-management-container">

        <!-- ========== ХЛЕБНЫЕ КРОШКИ И ЗАГОЛОВОК ========== -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin}">Главная</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin/projects}">Проекты</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin/projects/edit/{id}(id=${project.id})}">
                                <span th:text="${project.title}">Проект</span>
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            Управление командой
                        </li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-0">
                            <i class="bi bi-people me-2"></i>
                            Управление командой проекта
                        </h1>
                        <p class="text-muted mb-0 mt-1">
                            Проект: <strong th:text="${project.title}">Название проекта</strong> |
                            ID: <strong th:text="${project.id}">#</strong>
                        </p>
                    </div>
                    <div>
                        <a th:href="@{/admin/projects/edit/{id}(id=${project.id})}"
                           class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left me-1"></i>
                            Назад к проекту
                        </a>
                        <a th:href="@{/admin/team-members/create}"
                           class="btn btn-outline-success"
                           target="_blank">
                            <i class="bi bi-person-plus me-1"></i>
                            Новый член команды
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== СООБЩЕНИЯ ========== -->
        <div class="row mb-4">
            <div class="col-12">
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${successMessage}">Успешно!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}">Ошибка!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <!-- ========== ОСНОВНОЙ ИНТЕРФЕЙС УПРАВЛЕНИЯ ========== -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">

                            <!-- ЛЕВАЯ КОЛОНКА: ДОСТУПНЫЕ ЧЛЕНЫ КОМАНДЫ -->
                            <div class="col-md-5">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="h5 mb-0">
                                        <i class="bi bi-people-fill text-primary me-2"></i>
                                        Все члены команды
                                    </h4>
                                    <span class="badge bg-primary">
                                        <span th:text="${availableMembers != null ? availableMembers.size() : 0}">0</span> чел.
                                    </span>
                                </div>

                                <!-- Поиск -->
                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control"
                                           id="searchAvailable"
                                           placeholder="Поиск по имени или должности...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>

                                <!-- Список доступных членов команды -->
                                <div class="team-list-container" id="availableMembersList">
                                    <div th:if="${availableMembers != null && !availableMembers.isEmpty()}">
                                        <div class="team-member-card"
                                             th:each="member : ${availableMembers}"
                                             th:data-member-id="${member.id}"
                                             onclick="selectAvailableMember(this)">
                                            <div class="d-flex align-items-center">
                                                <!-- Аватар -->
                                                <div class="me-3">
                                                    <img th:if="${member.avatarPath != null && !member.avatarPath.isEmpty()}"
                                                         th:src="@{${member.avatarPath}}"
                                                         class="avatar-small"
                                                         alt="Аватар">
                                                    <div th:unless="${member.avatarPath != null && !member.avatarPath.isEmpty()}"
                                                         class="avatar-small bg-secondary d-flex align-items-center justify-content-center text-white">
                                                        <i class="bi bi-person"></i>
                                                    </div>
                                                </div>
                                                <!-- Информация -->
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1" th:text="${member.fullName}">ФИО</h6>
                                                    <p class="mb-0 text-muted small" th:text="${member.position} ?: 'Должность не указана'">
                                                        Должность
                                                    </p>
                                                </div>
                                                <!-- Статус -->
                                                <div class="text-end">
                                                    <span th:if="${member.active}"
                                                          class="badge bg-success">Активен</span>
                                                    <span th:unless="${member.active}"
                                                          class="badge bg-secondary">Неактивен</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${availableMembers == null || availableMembers.isEmpty()}"
                                         class="empty-state">
                                        <i class="bi bi-people"></i>
                                        <h5>Нет доступных членов команды</h5>
                                        <p class="mb-0">
                                            Все члены команды уже участвуют в проекте или отсутствуют в системе
                                        </p>
                                        <a th:href="@{/admin/team-members/create}"
                                           class="btn btn-outline-primary mt-3">
                                            <i class="bi bi-person-plus me-1"></i>
                                            Добавить члена команды
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- ЦЕНТРАЛЬНАЯ КОЛОНКА: КНОПКИ ПЕРЕНОСА -->
                            <div class="col-md-2">
                                <div class="transfer-buttons">
                                    <button class="btn btn-primary btn-lg mb-3"
                                            id="addToProject"
                                            onclick="addSelectedToProject()"
                                            disabled>
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                    <div class="text-center mb-2">
                                        <small class="text-muted">Добавить в проект</small>
                                    </div>

                                    <button class="btn btn-danger btn-lg mt-4"
                                            id="removeFromProject"
                                            onclick="removeSelectedFromProject()"
                                            disabled>
                                        <i class="bi bi-arrow-left"></i>
                                    </button>
                                    <div class="text-center mt-2">
                                        <small class="text-muted">Убрать из проекта</small>
                                    </div>

                                    <div class="mt-5 pt-4 border-top text-center">
                                        <form th:action="@{/admin/projects/{id}/team/save(id=${project.id})}"
                                              method="post"
                                              id="saveTeamForm">
                                            <input type="hidden"
                                                   th:name="${_csrf.parameterName}"
                                                   th:value="${_csrf.token}" />
                                            <input type="hidden" name="teamMemberIds" id="teamMemberIdsInput">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-save me-1"></i>
                                                Сохранить изменения
                                            </button>
                                        </form>
                                        <small class="text-muted d-block mt-2">
                                            Изменения сохраняются после нажатия этой кнопки
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- ПРАВАЯ КОЛОНКА: УЧАСТНИКИ ПРОЕКТА -->
                            <div class="col-md-5">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="h5 mb-0">
                                        <i class="bi bi-person-check-fill text-success me-2"></i>
                                        Участники проекта
                                    </h4>
                                    <span class="badge bg-success">
                                        <span th:text="${projectMembers != null ? projectMembers.size() : 0}">0</span> чел.
                                    </span>
                                </div>

                                <!-- Список участников проекта -->
                                <div class="team-list-container" id="projectMembersList">
                                    <div th:if="${projectMembers != null && !projectMembers.isEmpty()}">
                                        <div class="team-member-card"
                                             th:each="member : ${projectMembers}"
                                             th:data-member-id="${member.id}"
                                             onclick="selectProjectMember(this)">
                                            <div class="d-flex align-items-center">
                                                <!-- Аватар -->
                                                <div class="me-3">
                                                    <img th:if="${member.avatarPath != null && !member.avatarPath.isEmpty()}"
                                                         th:src="@{${member.avatarPath}}"
                                                         class="avatar-small"
                                                         alt="Аватар">
                                                    <div th:unless="${member.avatarPath != null && !member.avatarPath.isEmpty()}"
                                                         class="avatar-small bg-secondary d-flex align-items-center justify-content-center text-white">
                                                        <i class="bi bi-person"></i>
                                                    </div>
                                                </div>
                                                <!-- Информация -->
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1" th:text="${member.fullName}">ФИО</h6>
                                                    <p class="mb-0 text-muted small" th:text="${member.position} ?: 'Должность не указана'">
                                                        Должность
                                                    </p>
                                                </div>
                                                <!-- Кнопка быстрого удаления -->
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        th:data-member-id="${member.id}"
                                                        onclick="removeSingleMember(this)">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${projectMembers == null || projectMembers.isEmpty()}"
                                         class="empty-state">
                                        <i class="bi bi-person-x"></i>
                                        <h5>Нет участников проекта</h5>
                                        <p class="mb-0">
                                            Добавьте членов команды из левой колонки
                                        </p>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- ===== СТАТИСТИКА ===== -->
                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="card bg-light">
                                            <div class="card-body py-3">
                                                <h3 class="mb-0" th:text="${projectMembers != null ? projectMembers.size() : 0}">0</h3>
                                                <small class="text-muted">Участников в проекте</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="card bg-light">
                                            <div class="card-body py-3">
                                                <h3 class="mb-0" th:text="${availableMembers != null ? availableMembers.size() : 0}">0</h3>
                                                <small class="text-muted">Доступно для добавления</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="card bg-light">
                                            <div class="card-body py-3">
                                                <h3 class="mb-0" th:text="${allTeamMembers != null ? allTeamMembers.size() : 0}">0</h3>
                                                <small class="text-muted">Всего в команде</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="card bg-light">
                                            <div class="card-body py-3">
                                                <h3 class="mb-0" th:text="${project.id}">0</h3>
                                                <small class="text-muted">ID проекта</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript для управления командой -->
<script>
    // Глобальные переменные для хранения выбранных элементов
    let selectedAvailableMember = null;
    let selectedProjectMember = null;

    // Выбор члена команды из доступных
    function selectAvailableMember(element) {
        // Снимаем выделение с предыдущего выбора
        if (selectedAvailableMember) {
            selectedAvailableMember.classList.remove('selected');
        }

        // Выделяем новый элемент
        element.classList.add('selected');
        selectedAvailableMember = element;

        // Активируем кнопку добавления
        document.getElementById('addToProject').disabled = false;

        // Деактивируем кнопку удаления (если была активна)
        document.getElementById('removeFromProject').disabled = true;
    }

    // Выбор участника проекта
    function selectProjectMember(element) {
        // Снимаем выделение с предыдущего выбора
        if (selectedProjectMember) {
            selectedProjectMember.classList.remove('selected');
        }

        // Выделяем новый элемент
        element.classList.add('selected');
        selectedProjectMember = element;

        // Активируем кнопку удаления
        document.getElementById('removeFromProject').disabled = false;

        // Деактивируем кнопку добавления (если была активна)
        document.getElementById('addToProject').disabled = true;
    }

    // Добавить выбранного члена в проект
    function addSelectedToProject() {
        if (!selectedAvailableMember) return;

        const memberId = selectedAvailableMember.getAttribute('data-member-id');
        const memberCard = selectedAvailableMember.cloneNode(true);

        // Удаляем обработчик клика и добавляем новый
        memberCard.removeAttribute('onclick');
        memberCard.onclick = function() { selectProjectMember(this); };

        // Добавляем кнопку быстрого удаления
        const buttonCell = memberCard.querySelector('.text-end');
        if (buttonCell) {
            buttonCell.innerHTML = `
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-member-id="${memberId}"
                        onclick="removeSingleMember(this)">
                    <i class="bi bi-x"></i>
                </button>
            `;
        }

        // Перемещаем карточку в правую колонку
        document.getElementById('projectMembersList').insertBefore(
            memberCard,
            document.getElementById('projectMembersList').firstChild
        );

        // Удаляем из левой колонки
        selectedAvailableMember.remove();

        // Обновляем статистику
        updateStats();

        // Сбрасываем выбор
        selectedAvailableMember = null;
        document.getElementById('addToProject').disabled = true;
    }

    // Удалить выбранного участника из проекта
    function removeSelectedFromProject() {
        if (!selectedProjectMember) return;

        const memberId = selectedProjectMember.getAttribute('data-member-id');
        const memberCard = selectedProjectMember.cloneNode(true);

        // Удаляем кнопку быстрого удаления и добавляем статус
        const buttonCell = memberCard.querySelector('.btn-outline-danger');
        if (buttonCell) {
            buttonCell.parentElement.innerHTML = `
                <span class="badge bg-success">Активен</span>
            `;
        }

        // Удаляем обработчик клика и добавляем новый
        memberCard.removeAttribute('onclick');
        memberCard.onclick = function() { selectAvailableMember(this); };

        // Добавляем в левую колонку
        document.getElementById('availableMembersList').insertBefore(
            memberCard,
            document.getElementById('availableMembersList').firstChild
        );

        // Удаляем из правой колонки
        selectedProjectMember.remove();

        // Обновляем статистику
        updateStats();

        // Сбрасываем выбор
        selectedProjectMember = null;
        document.getElementById('removeFromProject').disabled = true;
    }

    // Удалить одного участника (по кнопке X)
    function removeSingleMember(button) {
        const memberCard = button.closest('.team-member-card');
        const memberId = memberCard.getAttribute('data-member-id');
        const clonedCard = memberCard.cloneNode(true);

        // Удаляем кнопку быстрого удаления и добавляем статус
        const buttonCell = clonedCard.querySelector('.btn-outline-danger');
        if (buttonCell) {
            buttonCell.parentElement.innerHTML = `
                <span class="badge bg-success">Активен</span>
            `;
        }

        // Удаляем обработчик клика и добавляем новый
        clonedCard.removeAttribute('onclick');
        clonedCard.onclick = function() { selectAvailableMember(this); };

        // Добавляем в левую колонку
        document.getElementById('availableMembersList').insertBefore(
            clonedCard,
            document.getElementById('availableMembersList').firstChild
        );

        // Удаляем из правой колонки
        memberCard.remove();

        // Обновляем статистику
        updateStats();
    }

    // Поиск в левой колонке
    document.getElementById('searchAvailable').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const members = document.querySelectorAll('#availableMembersList .team-member-card');

        members.forEach(member => {
            const name = member.querySelector('h6').textContent.toLowerCase();
            const position = member.querySelector('.small').textContent.toLowerCase();

            if (name.includes(searchTerm) || position.includes(searchTerm)) {
                member.style.display = 'block';
            } else {
                member.style.display = 'none';
            }
        });
    });

    // Очистка поиска
    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('searchAvailable').value = '';
        const members = document.querySelectorAll('#availableMembersList .team-member-card');
        members.forEach(member => member.style.display = 'block');
    });

    // Обновление статистики
    function updateStats() {
        const availableCount = document.querySelectorAll('#availableMembersList .team-member-card').length;
        const projectCount = document.querySelectorAll('#projectMembersList .team-member-card').length;

        // Обновляем бейджи
        document.querySelector('#availableMembersList').previousElementSibling
            .querySelector('.badge').textContent = availableCount + ' чел.';

        document.querySelector('#projectMembersList').previousElementSibling
            .querySelector('.badge').textContent = projectCount + ' чел.';

        // Обновляем карточки статистики
        document.querySelectorAll('.card.bg-light h3')[0].textContent = projectCount;
        document.querySelectorAll('.card.bg-light h3')[1].textContent = availableCount;

        // Обновляем hidden input для сохранения
        updateHiddenInput();
    }

    // Обновление hidden input для отправки на сервер
    function updateHiddenInput() {
        const projectMemberIds = Array.from(
            document.querySelectorAll('#projectMembersList .team-member-card')
        ).map(card => card.getAttribute('data-member-id'));

        document.getElementById('teamMemberIdsInput').value = projectMemberIds.join(',');
    }

    // Инициализация hidden input при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        updateHiddenInput();

        // Показываем пустые состояния если нужно
        const availableEmpty = document.querySelector('#availableMembersList .empty-state');
        const projectEmpty = document.querySelector('#projectMembersList .empty-state');

        if (availableEmpty && document.querySelectorAll('#availableMembersList .team-member-card').length > 0) {
            availableEmpty.style.display = 'none';
        }

        if (projectEmpty && document.querySelectorAll('#projectMembersList .team-member-card').length > 0) {
            projectEmpty.style.display = 'none';
        }
    });
</script>
</body>
</html>