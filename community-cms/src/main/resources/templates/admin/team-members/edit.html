<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Редактирование члена команды - Админ панель</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        .team-edit-container {
            max-width: 900px;
            margin: 0 auto;
            padding-left: 20px;
            padding-right: 20px;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #0d6efd;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #dee2e6;
            background-color: #f8f9fa;
        }

        .avatar-placeholder-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            border: 3px solid #dee2e6;
        }

        .current-avatar-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .member-info-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid team-edit-container">

        <!-- ========== ЗАГОЛОВОК И НАВИГАЦИЯ ========== -->
        <div class="row mb-4">
            <div class="col-12">
                <!-- Хлебные крошки -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin}">Главная</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin/team-members}">Команда</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            Редактирование
                        </li>
                    </ol>
                </nav>

                <!-- Заголовок и информация о члене команды -->
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-0">
                            <i class="bi bi-person-gear me-2"></i>
                            Редактирование члена команды
                        </h1>
                        <p class="text-muted mb-0 mt-1">
                            ID: <strong th:text="${teamMember.id}">#</strong> |
                            Создан: <span th:text="${teamMember.createdAt != null ? #temporals.format(teamMember.createdAt, 'dd.MM.yyyy HH:mm') : '—'}">—</span>
                        </p>
                    </div>
                    <div>
                        <a th:href="@{/admin/team-members}" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left me-1"></i>
                            Назад к списку
                        </a>
                        <a th:href="@{/admin/team-members/projects/{id}(id=${teamMember.id})}"
                           class="btn btn-outline-primary">
                            <i class="bi bi-kanban me-1"></i>
                            Управление проектами
                        </a>
                    </div>
                </div>

                <!-- Карточка информации -->
                <div class="member-info-card mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Член команды:</strong>
                            <span th:text="${teamMember.fullName}">ФИО</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Статус:</strong>
                            <span th:if="${teamMember.active}" class="badge bg-success">Активен</span>
                            <span th:unless="${teamMember.active}" class="badge bg-secondary">Неактивен</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== СООБЩЕНИЯ ========== -->
        <div class="row mb-4" th:if="${successMessage} or ${errorMessage}">
            <div class="col-12">
                <div th:if="${successMessage}"
                     class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${errorMessage}"
                     class="alert alert-danger alert-dismissible fade show">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <!-- ========== ОСНОВНАЯ ФОРМА ========== -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Форма редактирования -->
                        <form th:action="@{/admin/team-members/edit/{id}(id=${teamMember.id})}"
                              th:object="${teamMember}"
                              method="post">

                            <!-- Скрытый CSRF токен -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <!-- Скрытое поле ID -->
                            <input type="hidden" th:field="*{id}" />

                            <!-- ===== СЕКЦИЯ 1: ОСНОВНАЯ ИНФОРМАЦИЯ ===== -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-person-circle me-2"></i>
                                    Основная информация
                                </h3>

                                <div class="row">
                                    <!-- Полное имя -->
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label required-field">
                                            Полное имя
                                        </label>
                                        <input type="text"
                                               class="form-control"
                                               id="fullName"
                                               th:field="*{fullName}"
                                               placeholder="Иванов Иван Иванович"
                                               required>
                                        <div class="form-text">
                                            Фамилия Имя Отчество полностью
                                        </div>
                                        <div th:if="${#fields.hasErrors('fullName')}" class="text-danger small">
                                            <span th:errors="*{fullName}"></span>
                                        </div>
                                    </div>

                                    <!-- Должность -->
                                    <div class="col-md-6 mb-3">
                                        <label for="position" class="form-label required-field">
                                            Должность
                                        </label>
                                        <input type="text"
                                               class="form-control"
                                               id="position"
                                               th:field="*{position}"
                                               placeholder="Руководитель проекта"
                                               required>
                                        <div class="form-text">
                                            Основная должность в организации
                                        </div>
                                        <div th:if="${#fields.hasErrors('position')}" class="text-danger small">
                                            <span th:errors="*{position}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== СЕКЦИЯ 2: АВАТАР ===== -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-image me-2"></i>
                                    Фотография (аватар)
                                </h3>

                                <div class="row align-items-center">
                                    <!-- Превью текущего аватара -->
                                    <div class="col-md-4 text-center mb-3">
                                        <div id="avatarPreviewContainer">
                                            <img th:if="${teamMember.avatarPath != null and teamMember.avatarPath != ''}"
                                                 th:src="@{${teamMember.avatarPath}}"
                                                 class="avatar-preview mb-2"
                                                 alt="Текущий аватар">
                                            <div th:unless="${teamMember.avatarPath != null and teamMember.avatarPath != ''}"
                                                 class="avatar-placeholder-large mb-2"
                                                 th:text="${teamMember.initials}">
                                                ИП
                                            </div>

                                            <!-- Информация о текущем аватаре -->
                                            <div th:if="${teamMember.avatarPath != null and teamMember.avatarPath != ''}"
                                                 class="current-avatar-info">
                                                <p class="mb-1 small">
                                                    <i class="bi bi-check-circle text-success me-1"></i>
                                                    Фото загружено
                                                </p>
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="clearAvatar()">
                                                    <i class="bi bi-trash me-1"></i>
                                                    Удалить фото
                                                </button>
                                            </div>
                                            <div th:unless="${teamMember.avatarPath != null and teamMember.avatarPath != ''}"
                                                 class="current-avatar-info">
                                                <p class="mb-0 small text-muted">
                                                    <i class="bi bi-image me-1"></i>
                                                    Фото не загружено
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Поле загрузки нового аватара -->
                                    <div class="col-md-8 mb-3">
                                        <label for="avatarFile" class="form-label">
                                            Заменить фото
                                        </label>
                                        <input type="file"
                                               class="form-control"
                                               id="avatarFile"
                                               name="avatarFile"
                                               accept="image/*">
                                        <div class="form-text">
                                            Рекомендуемый размер: 400x400px. Форматы: JPG, PNG
                                            <br>Оставьте пустым, чтобы сохранить текущее фото
                                        </div>

                                        <!-- Скрытое поле для пути к аватару -->
                                        <input type="hidden" id="avatarPath" th:field="*{avatarPath}">
                                        <input type="hidden" id="clearAvatarFlag" name="clearAvatar" value="false">
                                    </div>
                                </div>
                            </div>

                            <!-- ===== СЕКЦИЯ 3: КОНТАКТНАЯ ИНФОРМАЦИЯ ===== -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-envelope me-2"></i>
                                    Контактная информация
                                </h3>

                                <div class="row">
                                    <!-- Email -->
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">
                                            Электронная почта
                                        </label>
                                        <input type="email"
                                               class="form-control"
                                               id="email"
                                               th:field="*{email}"
                                               placeholder="ivanov@example.com">
                                        <div class="form-text">
                                            Рабочий email адрес
                                        </div>
                                        <div th:if="${#fields.hasErrors('email')}" class="text-danger small">
                                            <span th:errors="*{email}"></span>
                                        </div>
                                    </div>

                                    <!-- Телефон -->
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">
                                            Телефон
                                        </label>
                                        <input type="tel"
                                               class="form-control"
                                               id="phone"
                                               th:field="*{phone}"
                                               placeholder="+7 (XXX) XXX-XX-XX">
                                        <div class="form-text">
                                            Рабочий номер телефона
                                        </div>
                                        <div th:if="${#fields.hasErrors('phone')}" class="text-danger small">
                                            <span th:errors="*{phone}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== СЕКЦИЯ 4: БИОГРАФИЯ ===== -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-file-text me-2"></i>
                                    Биография
                                </h3>

                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="bio" class="form-label">
                                            Биография
                                        </label>
                                        <textarea class="form-control"
                                                  id="bio"
                                                  th:field="*{bio}"
                                                  rows="5"
                                                  placeholder="Опыт работы, образование, достижения..."></textarea>
                                        <div class="form-text">
                                            Можно использовать HTML-разметку для форматирования
                                        </div>
                                        <div th:if="${#fields.hasErrors('bio')}" class="text-danger small">
                                            <span th:errors="*{bio}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== СЕКЦИЯ 5: НАСТРОЙКИ ===== -->
                            <div class="form-section">
                                <h3 class="form-section-title">
                                    <i class="bi bi-gear me-2"></i>
                                    Настройки
                                </h3>

                                <div class="row">
                                    <!-- Порядок сортировки -->
                                    <div class="col-md-4 mb-3">
                                        <label for="sortOrder" class="form-label">
                                            Порядок сортировки
                                        </label>
                                        <input type="number"
                                               class="form-control"
                                               id="sortOrder"
                                               th:field="*{sortOrder}"
                                               min="0"
                                               max="999">
                                        <div class="form-text">
                                            Меньшее число = выше в списке
                                        </div>
                                        <div th:if="${#fields.hasErrors('sortOrder')}" class="text-danger small">
                                            <span th:errors="*{sortOrder}"></span>
                                        </div>
                                    </div>

                                    <!-- Статус активности -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Статус</label>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   id="active"
                                                   th:field="*{active}">
                                            <label class="form-check-label" for="active">
                                                Активный член команды
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            Неактивные не отображаются на сайте
                                        </div>
                                    </div>

                                    <!-- Дата обновления (только для информации) -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Последнее обновление</label>
                                        <p class="form-control-plaintext">
                                            <span th:if="${teamMember.updatedAt != null}"
                                                  th:text="${#temporals.format(teamMember.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                            </span>
                                            <span th:unless="${teamMember.updatedAt != null}" class="text-muted">
                                                —
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== КНОПКИ ДЕЙСТВИЙ ===== -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <a th:href="@{/admin/team-members/delete/{id}(id=${teamMember.id})}"
                                               class="btn btn-outline-danger me-2">
                                                <i class="bi bi-trash me-1"></i>
                                                Удалить
                                            </a>
                                            <a th:href="@{/admin/team-members}" class="btn btn-outline-secondary">
                                                <i class="bi bi-x-circle me-1"></i>
                                                Отмена
                                            </a>
                                        </div>
                                        <div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Сохранить изменения
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="row mt-4">
                    <!-- Статистика -->
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-kanban me-2"></i>
                                    Участие в проектах
                                </h5>
                                <div class="d-flex align-items-center">
                                    <span class="display-6 me-3" th:text="${memberProjects != null ? memberProjects.size() : 0}">0</span>
                                    <div>
                                        <p class="mb-1">Проектов</p>
                                        <a th:href="@{/admin/team-members/projects/{id}(id=${teamMember.id})}"
                                           class="btn btn-sm btn-outline-primary">
                                            Управление проектами
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Подсказки -->
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    Подсказки
                                </h5>
                                <ul class="small mb-0">
                                    <li>Измените порядок сортировки, чтобы управлять положением в списке</li>
                                    <li>Деактивируйте члена команды, чтобы временно скрыть с сайта</li>
                                    <li>Для полного удаления используйте кнопку "Удалить"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript для редактирования -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Страница редактирования члена команды загружена');

        // Предпросмотр нового аватара
        const avatarFileInput = document.getElementById('avatarFile');
        const avatarPreviewContainer = document.getElementById('avatarPreviewContainer');
        const avatarPathInput = document.getElementById('avatarPath');
        const clearAvatarFlag = document.getElementById('clearAvatarFlag');

        if (avatarFileInput) {
            avatarFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        // Обновляем превью
                        avatarPreviewContainer.innerHTML = `
                            <img src="${e.target.result}"
                                 class="avatar-preview mb-2"
                                 alt="Новый аватар">
                            <div class="current-avatar-info">
                                <p class="mb-1 small text-success">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Новое фото выбрано
                                </p>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="clearNewAvatar()">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Отмена замены
                                </button>
                            </div>
                        `;

                        // Сбрасываем флаг удаления, если пользователь загружает новое фото
                        clearAvatarFlag.value = 'false';
                    };

                    reader.readAsDataURL(file);
                }
            });
        }

        // Автоматическое определение инициалов из имени
        const fullNameInput = document.getElementById('fullName');

        if (fullNameInput) {
            fullNameInput.addEventListener('input', function() {
                const name = this.value.trim();
                const currentAvatar = avatarPathInput.value;

                // Если аватар не загружен, обновляем инициалы в превью
                if (!currentAvatar && name) {
                    const words = name.split(' ');
                    let initials = '';

                    if (words.length >= 2) {
                        initials = (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
                    } else if (words.length === 1) {
                        initials = words[0].charAt(0).toUpperCase();
                    }

                    // Обновляем заглушку в превью
                    const placeholder = avatarPreviewContainer.querySelector('.avatar-placeholder-large');
                    if (placeholder && !avatarFileInput.files[0]) {
                        placeholder.textContent = initials;
                    }
                }
            });
        }

        // Валидация формы перед отправкой
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const fullName = document.getElementById('fullName').value.trim();
                const position = document.getElementById('position').value.trim();

                if (!fullName || !position) {
                    e.preventDefault();
                    alert('Пожалуйста, заполните обязательные поля: Полное имя и Должность');
                    return false;
                }

                return true;
            });
        }
    });

    // Функция для удаления текущего аватара
    function clearAvatar() {
        if (confirm('Удалить текущее фото? Это действие нельзя отменить.')) {
            document.getElementById('clearAvatarFlag').value = 'true';
            document.getElementById('avatarPath').value = '';

            // Обновляем превью
            const avatarPreviewContainer = document.getElementById('avatarPreviewContainer');
            const fullNameInput = document.getElementById('fullName');
            let initials = '';

            if (fullNameInput) {
                const name = fullNameInput.value.trim();
                const words = name.split(' ');

                if (words.length >= 2) {
                    initials = (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
                } else if (words.length === 1) {
                    initials = words[0].charAt(0).toUpperCase();
                }
            }

            avatarPreviewContainer.innerHTML = `
                <div class="avatar-placeholder-large mb-2">
                    ${initials || '<i class="bi bi-person"></i>'}
                </div>
                <div class="current-avatar-info">
                    <p class="mb-0 small text-danger">
                        <i class="bi bi-trash me-1"></i>
                        Фото будет удалено при сохранении
                    </p>
                </div>
            `;

            // Сбрасываем поле загрузки файла
            const avatarFileInput = document.getElementById('avatarFile');
            if (avatarFileInput) {
                avatarFileInput.value = '';
            }
        }
    }

    // Функция для отмены загрузки нового аватара
    function clearNewAvatar() {
        const avatarFileInput = document.getElementById('avatarFile');
        const avatarPreviewContainer = document.getElementById('avatarPreviewContainer');
        const avatarPath = document.getElementById('avatarPath').value;
        const fullNameInput = document.getElementById('fullName');

        // Сбрасываем поле файла
        avatarFileInput.value = '';

        // Восстанавливаем оригинальное превью
        if (avatarPath) {
            // Если был оригинальный аватар
            avatarPreviewContainer.innerHTML = `
                <img th:src="@{${teamMember.avatarPath}}"
                     src="${avatarPath}"
                     class="avatar-preview mb-2"
                     alt="Текущий аватар">
                <div class="current-avatar-info">
                    <p class="mb-1 small">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Фото загружено
                    </p>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            onclick="clearAvatar()">
                        <i class="bi bi-trash me-1"></i>
                        Удалить фото
                    </button>
                </div>
            `;
        } else {
            // Если аватара не было
            let initials = '';
            if (fullNameInput) {
                const name = fullNameInput.value.trim();
                const words = name.split(' ');

                if (words.length >= 2) {
                    initials = (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
                } else if (words.length === 1) {
                    initials = words[0].charAt(0).toUpperCase();
                }
            }

            avatarPreviewContainer.innerHTML = `
                <div class="avatar-placeholder-large mb-2">
                    ${initials || '<i class="bi bi-person"></i>'}
                </div>
                <div class="current-avatar-info">
                    <p class="mb-0 small text-muted">
                        <i class="bi bi-image me-1"></i>
                        Фото не загружено
                    </p>
                </div>
            `;
        }
    }
</script>
</body>
</html>