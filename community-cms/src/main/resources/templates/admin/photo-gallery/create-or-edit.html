<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title th:text="${isEdit} ? 'Редактирование элемента' : 'Создание элемента'">
        Фото-галерея - Админ панель
    </title>

    <!-- Подключаем стили для формы -->
    <link rel="stylesheet" th:href="@{/css/photo-gallery-form.css}">

    <!-- Подключаем JavaScript для формы -->
    <script th:src="@{/js/photo-gallery-form.js}" defer></script>

    <!-- Библиотека для Drag & Drop (опционально) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <!-- ========== ЗАГОЛОВОК ФОРМЫ ========== -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/admin/photo-gallery}" class="text-decoration-none">
                                <i class="bi bi-images me-1"></i>
                                <span th:text="#{photo.gallery.title}">Фото-галерея</span>
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <span th:if="${isEdit}">
                                <i class="bi bi-pencil me-1"></i>
                                <span th:text="#{photo.gallery.edit}">Редактирование</span>
                            </span>
                            <span th:unless="${isEdit}">
                                <i class="bi bi-plus-circle me-1"></i>
                                <span th:text="#{photo.gallery.create}">Создание</span>
                            </span>
                        </li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h2 mb-0">
                        <i class="bi"
                           th:class="${isEdit} ? 'bi-pencil-square' : 'bi-plus-circle'"
                           th:text="${isEdit} ? 'Редактирование элемента' : 'Создание нового элемента'">
                        </i>
                        <span th:if="${isEdit && photoGalleryItem?.title}"
                              class="text-muted ms-2"
                              style="font-size: 1rem;">
                            "<span th:text="${photoGalleryItem.title}"></span>"
                        </span>
                    </h1>

                    <!-- Кнопка "Назад" -->
                    <a th:href="@{/admin/photo-gallery}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        <span th:text="#{common.back}">Назад</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- ========== СООБЩЕНИЯ ОБ УСПЕХЕ/ОШИБКЕ ========== -->
        <div th:if="${successMessage}" class="row mb-3">
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${successMessage}">Операция выполнена успешно</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <div th:if="${errorMessage}" class="row mb-3">
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${errorMessage}">Произошла ошибка</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <!-- ========== ОСНОВНАЯ ФОРМА ========== -->
        <form th:action="${isEdit} ?
                          @{/admin/photo-gallery/edit/{id}(id=${photoGalleryItem.id})} :
                          @{/admin/photo-gallery/create}"
              method="post"
              enctype="multipart/form-data"
              id="photoGalleryForm"
              novalidate>

            <!-- CSRF токен -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <!-- ID элемента (только для редактирования) -->
            <input type="hidden" th:if="${isEdit}" th:name="id" th:value="${photoGalleryItem.id}">

            <div class="row">
                <!-- ========== ЛЕВАЯ КОЛОНКА: ОСНОВНАЯ ИНФОРМАЦИЯ ========== -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <span th:text="#{photo.gallery.form.basic.info}">Основная информация</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Название -->
                            <div class="mb-4">
                                <label for="title" class="form-label fw-semibold">
                                    <span th:text="#{photo.gallery.form.title}">Название элемента *</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''"
                                       id="title"
                                       th:field="*{title}"
                                       placeholder="Введите название элемента"
                                       required
                                       minlength="3"
                                       maxlength="255">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}">
                                    <span th:errors="*{title}">Ошибка в названии</span>
                                </div>
                                <div class="form-text">
                                    <span th:text="#{photo.gallery.form.title.help}">
                                        Название будет отображаться на сайте. Минимум 3 символа.
                                    </span>
                                </div>
                            </div>

                            <!-- Год -->
                            <div class="mb-4">
                                <label for="year" class="form-label fw-semibold">
                                    <span th:text="#{photo.gallery.form.year}">Год *</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       th:classappend="${#fields.hasErrors('year')} ? 'is-invalid' : ''"
                                       id="year"
                                       th:field="*{year}"
                                       placeholder="2024"
                                       required
                                       min="2000"
                                       max="2100"
                                       step="1">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('year')}">
                                    <span th:errors="*{year}">Ошибка в годе</span>
                                </div>
                                <div class="form-text">
                                    <span th:text="#{photo.gallery.form.year.help}">
                                        Год проведения мероприятия или создания контента (2000-2100).
                                    </span>
                                </div>
                            </div>

                            <!-- Описание -->
                            <div class="mb-4">
                                <label for="description" class="form-label fw-semibold">
                                    <span th:text="#{photo.gallery.form.description}">Описание</span>
                                    <span class="text-muted small">(необязательно)</span>
                                </label>
                                <textarea class="form-control"
                                          th:classappend="${#fields.hasErrors('description')} ? 'is-invalid' : ''"
                                          id="description"
                                          th:field="*{description}"
                                          placeholder="Описание элемента"
                                          rows="5"
                                          maxlength="2000"
                                          style="resize: vertical;"></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}">
                                    <span th:errors="*{description}">Ошибка в описании</span>
                                </div>
                                <div class="form-text">
                                    <span th:text="#{photo.gallery.form.description.help}">
                                        Подробное описание элемента. Максимум 2000 символов.
                                    </span>
                                    <span class="d-block mt-1">
                                        <small class="text-muted" id="descriptionCounter">0/2000</small>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== БЛОК КАТЕГОРИЙ ========== -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="bi bi-tags me-2"></i>
                                <span th:text="#{photo.gallery.form.categories}">Категории публикации *</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div th:classappend="${#fields.hasErrors('categories')} ? 'border-danger' : ''"
                                 class="border rounded p-3">
                                <div class="row g-3">
                                    <div th:each="category : ${categories}" class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input category-checkbox"
                                                   type="checkbox"
                                                   th:id="'category_' + ${category.id}"
                                                   th:value="${category.id}"
                                                   th:name="categoryIds"
                                                   th:checked="${selectedCategoryIds != null && selectedCategoryIds.contains(category.id)}">
                                            <label class="form-check-label d-flex align-items-center"
                                                   th:for="'category_' + ${category.id}">
                                                <span class="badge me-2"
                                                      th:class="${category.name == 'Главная'} ? 'bg-danger' :
                                                                ${category.name == 'О нас'} ? 'bg-success' :
                                                                ${category.name == 'Наши проекты'} ? 'bg-primary' :
                                                                'bg-info'">
                                                    <span th:text="${category.name}">Категория</span>
                                                </span>
                                                <small class="text-muted"
                                                       th:text="${category.description}">
                                                    Описание категории
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div th:if="${#fields.hasErrors('categories')}" class="mt-2">
                                    <div class="text-danger small">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        <span th:errors="*{categories}">Выберите хотя бы одну категорию</span>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <span th:text="#{photo.gallery.form.categories.help}">
                                            Выберите категории, в которых будет опубликован элемент.
                                            Можно выбрать несколько категорий.
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== ПРАВАЯ КОЛОНКА: ИЗОБРАЖЕНИЯ И НАСТРОЙКИ ========== -->
                <div class="col-lg-4">
                    <!-- ========== ЗАГРУЗКА ФАЙЛОВ ========== -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="bi bi-images me-2"></i>
                                <span th:text="#{photo.gallery.form.images}">Изображения *</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Сообщение о необходимости загрузки файлов -->
                            <div th:if="${#fields.hasErrors('images')}" class="mb-3">
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span th:errors="*{images}">Загрузите хотя бы одно изображение</span>
                                </div>
                            </div>

                            <!-- Drag & Drop зона -->
                            <div id="dropzone" class="dropzone-area border rounded p-5 text-center mb-3">
                                <i class="bi bi-cloud-upload display-4 text-muted d-block mb-3"></i>
                                <h5 class="mb-2">
                                    <span th:text="#{photo.gallery.form.images.drop.title}">
                                        Перетащите изображения сюда
                                    </span>
                                </h5>
                                <p class="text-muted mb-3">
                                    <span th:text="#{photo.gallery.form.images.drop.subtitle}">
                                        или нажмите для выбора файлов
                                    </span>
                                </p>
                                <input type="file"
                                       id="fileInput"
                                       name="images"
                                       multiple
                                       accept="image/*"
                                       class="d-none"
                                       th:attr="data-max-files=${maxFiles}">
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-folder2-open me-1"></i>
                                    <span th:text="#{photo.gallery.form.images.browse}">Выбрать файлы</span>
                                </button>
                                <div class="mt-3 text-muted small">
                                    <span th:text="#{photo.gallery.form.images.limits}">
                                        Максимум 15 файлов, каждый до 5MB. Поддерживаются: JPG, PNG, GIF, WebP.
                                    </span>
                                </div>
                            </div>

                            <!-- Список загруженных файлов -->
                            <div id="uploadedFiles" class="d-none">
                                <h6 class="mb-3">
                                    <i class="bi bi-list-check me-1"></i>
                                    <span th:text="#{photo.gallery.form.images.list}">Загруженные изображения</span>
                                    <small class="text-muted" id="fileCount">(0)</small>
                                </h6>
                                <div id="fileList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Здесь будут отображаться загруженные файлы -->
                                </div>

                                <!-- Индикатор прогресса -->
                                <div class="progress mb-3 d-none" id="uploadProgress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar"
                                         style="width: 0%">
                                    </div>
                                </div>

                                <!-- Кнопки управления -->
                                <div class="d-flex justify-content-between">
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm"
                                            id="clearAllBtn">
                                        <i class="bi bi-trash me-1"></i>
                                        <span th:text="#{photo.gallery.form.images.clear.all}">Очистить все</span>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            id="sortToggleBtn">
                                        <i class="bi bi-arrow-down-up me-1"></i>
                                        <span th:text="#{photo.gallery.form.images.sort.toggle}">Сортировка</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Существующие изображения (только при редактировании) -->
                            <div th:if="${isEdit && photoGalleryItem.imagesCount > 0}"
                                 class="mt-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-image me-1"></i>
                                    <span th:text="#{photo.gallery.form.images.existing}">Существующие изображения</span>
                                    <small class="text-muted">(<span th:text="${photoGalleryItem.imagesCount}">0</span>)</small>
                                </h6>
                                <div class="row g-2 mb-3" id="existingImages">
                                    <div th:each="image, iter : ${photoGalleryItem.images}"
                                         class="col-4">
                                        <div class="position-relative border rounded overflow-hidden">
                                            <img th:src="@{${image.filePath}}"
                                                 th:alt="${image.fileName}"
                                                 class="img-fluid w-100"
                                                 style="height: 80px; object-fit: cover;">
                                            <div class="position-absolute top-0 end-0 p-1">
                                                <span th:if="${image.isPrimary}"
                                                      class="badge bg-success">
                                                    <i class="bi bi-star-fill"></i>
                                                </span>
                                            </div>
                                            <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 p-1">
                                                <small class="text-white d-block text-truncate"
                                                       th:text="${image.fileName}">
                                                    файл.jpg
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span th:text="#{photo.gallery.form.images.existing.help}">
                                        Существующие изображения будут сохранены. Вы можете добавить новые.
                                    </span>
                                </div>
                            </div>

                            <!-- Счетчик файлов -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <span th:text="#{photo.gallery.form.images.current}">Текущее количество:</span>
                                        <span id="currentFileCount"
                                              th:text="${isEdit} ? ${photoGalleryItem.imagesCount} : 0">
                                            0
                                        </span>
                                        /
                                        <span th:text="${maxFiles}">15</span>
                                    </small>
                                    <small th:if="${isEdit}" class="text-warning">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        <span th:text="#{photo.gallery.form.images.max.warning}">
                                            Можно добавить еще
                                            <span th:text="${maxFiles - photoGalleryItem.imagesCount}">15</span>
                                            файлов
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== НАСТРОЙКИ ПУБЛИКАЦИИ ========== -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="bi bi-gear me-2"></i>
                                <span th:text="#{photo.gallery.form.settings}">Настройки публикации</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Статус публикации -->
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="published"
                                       th:field="*{published}"
                                       th:checked="*{published}">
                                <label class="form-check-label fw-semibold" for="published">
                                    <span th:text="#{photo.gallery.form.published}">Опубликовано</span>
                                </label>
                                <div class="form-text">
                                    <span th:text="#{photo.gallery.form.published.help}">
                                        Если включено, элемент будет виден на сайте.
                                    </span>
                                </div>
                            </div>

                            <!-- Дата создания (только для информации) -->
                            <div th:if="${isEdit && photoGalleryItem.createdAt}" class="mb-3">
                                <label class="form-label fw-semibold">
                                    <span th:text="#{photo.gallery.form.created}">Создано</span>
                                </label>
                                <div class="form-control bg-light">
                                    <i class="bi bi-calendar me-1"></i>
                                    <span th:text="${#temporals.format(photoGalleryItem.createdAt, 'dd.MM.yyyy HH:mm')}">
                                        01.01.2024 12:00
                                    </span>
                                </div>
                            </div>

                            <!-- Дата обновления (только для информации) -->
                            <div th:if="${isEdit && photoGalleryItem.updatedAt}" class="mb-3">
                                <label class="form-label fw-semibold">
                                    <span th:text="#{photo.gallery.form.updated}">Обновлено</span>
                                </label>
                                <div class="form-control bg-light">
                                    <i class="bi bi-clock-history me-1"></i>
                                    <span th:text="${#temporals.format(photoGalleryItem.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                        01.01.2024 12:00
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== КНОПКИ ДЕЙСТВИЙ ========== -->
                    <div class="sticky-top" style="top: 20px; z-index: 1000;">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <!-- Кнопка сохранения -->
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            id="submitBtn">
                                        <i class="bi"
                                           th:class="${isEdit} ? 'bi-check-circle' : 'bi-plus-circle'">
                                        </i>
                                        <span th:text="${isEdit} ?
                                                       #{photo.gallery.form.save} :
                                                       #{photo.gallery.form.create}">
                                            Сохранить
                                        </span>
                                    </button>

                                    <!-- Кнопка предпросмотра -->
                                    <button type="button"
                                            class="btn btn-outline-info"
                                            id="previewBtn"
                                            th:if="${isEdit}">
                                        <i class="bi bi-eye me-1"></i>
                                        <span th:text="#{photo.gallery.form.preview}">Предпросмотр</span>
                                    </button>

                                    <!-- Кнопка отмены -->
                                    <a th:href="@{/admin/photo-gallery}"
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle me-1"></i>
                                        <span th:text="#{common.cancel}">Отмена</span>
                                    </a>

                                    <!-- Кнопка удаления (только при редактировании) -->
                                    <button type="button"
                                            class="btn btn-outline-danger mt-3"
                                            id="deleteBtn"
                                            th:if="${isEdit}"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal">
                                        <i class="bi bi-trash me-1"></i>
                                        <span th:text="#{photo.gallery.form.delete}">Удалить элемент</span>
                                    </button>
                                </div>

                                <!-- Сообщение о валидации -->
                                <div class="mt-3">
                                    <div class="alert alert-warning mb-0 d-none" id="validationAlert">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <span th:text="#{photo.gallery.form.validation.warning}">
                                            Проверьте форму. Есть ошибки или не заполнены обязательные поля.
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- ========== МОДАЛЬНОЕ ОКНО ПОДТВЕРЖДЕНИЯ УДАЛЕНИЯ ========== -->
    <div th:if="${isEdit}" class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        <span th:text="#{photo.gallery.delete.confirm.title}">Подтверждение удаления</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <span th:text="#{photo.gallery.delete.confirm.message}">
                            Вы уверены, что хотите удалить этот элемент?
                        </span>
                    </p>
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-octagon-fill me-2"></i>
                        <strong th:text="#{photo.gallery.delete.confirm.warning}">
                            Внимание:
                        </strong>
                        <span th:text="#{photo.gallery.delete.confirm.warning.details}">
                            Это действие нельзя отменить. Будут удалены все изображения, связанные с этим элементом.
                        </span>
                    </div>
                    <div th:if="${photoGalleryItem?.title}" class="mt-3">
                        <p class="mb-0">
                            <strong th:text="#{photo.gallery.delete.confirm.item}">Элемент:</strong>
                            "<span th:text="${photoGalleryItem.title}"></span>"
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>
                        <span th:text="#{common.cancel}">Отмена</span>
                    </button>
                    <form th:action="@{/admin/photo-gallery/delete/{id}(id=${photoGalleryItem.id})}"
                          method="post"
                          class="d-inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-1"></i>
                            <span th:text="#{photo.gallery.delete.confirm.button}">Удалить</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== JAVASCRIPT ДЛЯ ФОРМЫ ========== -->
<script th:inline="javascript">
    /*<![CDATA[*/

    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация формы
        initFormValidation();
        initFileUpload();
        initDescriptionCounter();
        initCategoryValidation();
        initPreviewButton();

        // Инициализация Bootstrap компонентов
        initBootstrapComponents();
    });

    /**
     * Инициализация валидации формы
     */
    function initFormValidation() {
        const form = document.getElementById('photoGalleryForm');
        const validationAlert = document.getElementById('validationAlert');
        const submitBtn = document.getElementById('submitBtn');

        if (!form) return;

        // Валидация при отправке
        form.addEventListener('submit', function(event) {
            if (!validateForm()) {
                event.preventDefault();
                event.stopPropagation();

                // Показываем сообщение об ошибке
                if (validationAlert) {
                    validationAlert.classList.remove('d-none');
                    validationAlert.scrollIntoView({ behavior: 'smooth' });
                }

                // Помечаем невалидные поля
                form.classList.add('was-validated');
            } else {
                // Блокируем кнопку отправки
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Сохранение...
                    `;
                }
            }
        });

        // Валидация при изменении полей
        const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
                if (validationAlert) {
                    validationAlert.classList.add('d-none');
                }
            });
        });
    }

    /**
     * Проверка валидности формы
     */
    function validateForm() {
        const form = document.getElementById('photoGalleryForm');
        if (!form) return false;

        let isValid = true;

        // Проверка обязательных полей
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });

        // Проверка категорий (минимум одна выбрана)
        const categoryCheckboxes = form.querySelectorAll('.category-checkbox:checked');
        if (categoryCheckboxes.length === 0) {
            const categoryContainer = document.querySelector('.category-checkbox').closest('.border');
            if (categoryContainer) {
                categoryContainer.classList.add('border-danger');
            }
            isValid = false;
        }

        // Проверка файлов (минимум один файл при создании)
        const isEdit = /*[[${isEdit}]]*/ false;
        if (!isEdit) {
            const fileInput = document.getElementById('fileInput');
            const currentFileCount = parseInt(document.getElementById('currentFileCount').textContent) || 0;

            if (currentFileCount === 0) {
                const dropzone = document.getElementById('dropzone');
                if (dropzone) {
                    dropzone.classList.add('border-danger');
                }
                isValid = false;
            }
        }

        return isValid;
    }

    /**
     * Инициализация загрузки файлов
     */
    function initFileUpload() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const currentFileCount = document.getElementById('currentFileCount');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const maxFiles = parseInt(fileInput.getAttribute('data-max-files')) || 15;
        const isEdit = /*[[${isEdit}]]*/ false;
        const existingCount = isEdit ? parseInt(currentFileCount.textContent) || 0 : 0;

        let files = [];

        // Обработчик выбора файлов
        fileInput.addEventListener('change', function(e) {
            handleFiles(Array.from(e.target.files));
            fileInput.value = ''; // Сбрасываем input
        });

        // Drag & Drop события
        if (dropzone) {
            // Предотвращаем стандартное поведение браузера
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            // Визуальные эффекты при перетаскивании
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });

            // Обработка сброса файлов
            dropzone.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const droppedFiles = Array.from(dt.files);
                handleFiles(droppedFiles);
            });

            // Клик по зоне drop
            dropzone.addEventListener('click', function() {
                fileInput.click();
            });
        }

        /**
         * Обработка выбранных файлов
         */
        function handleFiles(newFiles) {
            // Проверяем лимит файлов
            const totalFiles = files.length + newFiles.length + existingCount;
            if (totalFiles > maxFiles) {
                alert(`Максимальное количество файлов: ${maxFiles}. Вы пытаетесь загрузить ${newFiles.length} файлов, но уже есть ${files.length + existingCount}.`);
                return;
            }

            // Фильтруем только изображения
            newFiles = newFiles.filter(file => {
                if (!file.type.startsWith('image/')) {
                    alert(`Файл "${file.name}" не является изображением и будет пропущен.`);
                    return false;
                }

                // Проверяем размер файла (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`Файл "${file.name}" слишком большой (${(file.size / (1024 * 1024)).toFixed(2)} MB). Максимальный размер: 5MB.`);
                    return false;
                }

                return true;
            });

            // Добавляем файлы в список
            newFiles.forEach(file => {
                files.push(file);
                addFileToList(file);
            });

            // Обновляем интерфейс
            updateFileInterface();
        }

        /**
         * Добавление файла в список
         */
        function addFileToList(file) {
            const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const fileElement = document.createElement('div');
            fileElement.className = 'list-group-item';
            fileElement.id = fileId;
            fileElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center" style="flex: 1;">
                        <i class="bi bi-image text-primary me-3" style="font-size: 1.5rem;"></i>
                        <div style="flex: 1;">
                            <div class="fw-semibold text-truncate" title="${file.name}">
                                ${file.name}
                            </div>
                            <div class="small text-muted">
                                ${(file.size / 1024).toFixed(1)} KB
                            </div>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="setAsPrimary('${fileId}')" title="Сделать основным">
                            <i class="bi bi-star"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="removeFile('${fileId}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            fileList.appendChild(fileElement);

            // Предпросмотр изображения
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-fluid rounded me-3';
                img.style.width = '40px';
                img.style.height = '40px';
                img.style.objectFit = 'cover';

                const icon = fileElement.querySelector('.bi-image');
                icon.parentNode.replaceChild(img, icon);
            };
            reader.readAsDataURL(file);
        }

        /**
         * Обновление интерфейса файлов
         */
        function updateFileInterface() {
            // Обновляем счетчики
            if (fileCount) {
                fileCount.textContent = `(${files.length})`;
            }

            if (currentFileCount) {
                currentFileCount.textContent = files.length + existingCount;
            }

            // Показываем/скрываем блок с файлами
            if (uploadedFiles) {
                if (files.length > 0) {
                    uploadedFiles.classList.remove('d-none');
                } else {
                    uploadedFiles.classList.add('d-none');
                }
            }

            // Показываем предупреждение если файлов много
            const warningElement = document.querySelector('.text-warning');
            if (warningElement) {
                const remaining = maxFiles - (files.length + existingCount);
                if (remaining <= 3 && remaining > 0) {
                    warningElement.textContent = `Можно добавить еще ${remaining} файлов`;
                    warningElement.classList.remove('d-none');
                } else if (remaining <= 0) {
                    warningElement.textContent = 'Достигнут лимит файлов';
                    warningElement.classList.remove('d-none');
                } else {
                    warningElement.classList.add('d-none');
                }
            }

            // Обновляем DataTransfer для формы
            updateFormData();
        }

        /**
         * Обновление FormData для отправки
         */
        function updateFormData() {
            // Создаем новый DataTransfer
            const dt = new DataTransfer();
            files.forEach(file => {
                dt.items.add(file);
            });

            // Обновляем input файлов
            fileInput.files = dt.files;
        }

        /**
         * Удаление файла из списка
         */
        window.removeFile = function(fileId) {
            const fileElement = document.getElementById(fileId);
            if (!fileElement) return;

            // Находим индекс файла
            const index = Array.from(fileList.children).indexOf(fileElement);
            if (index !== -1) {
                files.splice(index, 1);
                fileElement.remove();
                updateFileInterface();
            }
        };

        /**
         * Установка файла как основного
         */
        window.setAsPrimary = function(fileId) {
            // Снимаем выделение с других файлов
            const primaryBtns = document.querySelectorAll('.btn-outline-primary .bi-star-fill');
            primaryBtns.forEach(btn => {
                btn.classList.replace('bi-star-fill', 'bi-star');
                btn.closest('.btn').classList.replace('btn-primary', 'btn-outline-primary');
            });

            // Выделяем текущий файл
            const targetBtn = document.querySelector(`#${fileId} .btn-outline-primary`);
            if (targetBtn) {
                const icon = targetBtn.querySelector('.bi');
                icon.classList.replace('bi-star', 'bi-star-fill');
                targetBtn.classList.replace('btn-outline-primary', 'btn-primary');

                // Перемещаем файл в начало списка
                const fileElement = document.getElementById(fileId);
                if (fileElement && fileElement.parentNode.firstChild !== fileElement) {
                    fileList.insertBefore(fileElement, fileList.firstChild);

                    // Также перемещаем файл в массиве
                    const index = files.findIndex(f =>
                        `file-${f.lastModified}-${f.name}` === fileId.replace(/[^a-zA-Z0-9-]/g, '')
                    );
                    if (index !== -1 && index !== 0) {
                        const [file] = files.splice(index, 1);
                        files.unshift(file);
                        updateFormData();
                    }
                }
            }
        };

        // Очистка всех файлов
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function() {
                if (confirm('Удалить все загруженные файлы?')) {
                    files = [];
                    fileList.innerHTML = '';
                    updateFileInterface();
                }
            });
        }

        // Вспомогательные функции для Drag & Drop
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropzone.classList.add('border-primary', 'bg-light');
        }

        function unhighlight() {
            dropzone.classList.remove('border-primary', 'bg-light');
        }
    }

    /**
     * Инициализация счетчика символов для описания
     */
    function initDescriptionCounter() {
        const description = document.getElementById('description');
        const counter = document.getElementById('descriptionCounter');

        if (description && counter) {
            // Устанавливаем начальное значение
            updateCounter();

            // Обновляем при изменении
            description.addEventListener('input', updateCounter);

            function updateCounter() {
                const length = description.value.length;
                counter.textContent = `${length}/2000`;

                if (length > 2000) {
                    counter.classList.add('text-danger');
                } else {
                    counter.classList.remove('text-danger');
                }
            }
        }
    }

    /**
     * Инициализация валидации категорий
     */
    function initCategoryValidation() {
        const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        const categoryContainer = document.querySelector('.category-checkbox')?.closest('.border');

        if (categoryCheckboxes && categoryContainer) {
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('.category-checkbox:checked').length;

                    if (checkedCount > 0) {
                        categoryContainer.classList.remove('border-danger');
                    }
                });
            });
        }
    }

    /**
     * Инициализация кнопки предпросмотра
     */
    function initPreviewButton() {
        const previewBtn = document.getElementById('previewBtn');

        if (previewBtn) {
            previewBtn.addEventListener('click', function() {
                const itemId = /*[[${photoGalleryItem?.id}]]*/ null;
                if (itemId) {
                    window.open(`/admin/photo-gallery/preview/${itemId}`, '_blank');
                }
            });
        }
    }

    /**
     * Инициализация Bootstrap компонентов
     */
    function initBootstrapComponents() {
        // Инициализация tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Инициализация модальных окон
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            const modal = new bootstrap.Modal(deleteModal);
        }
    }

    /*]]>*/
</script>

<!-- Стили для формы -->
<style>
    /* Стили для Drag & Drop зоны */
    .dropzone-area {
        border: 2px dashed #dee2e6;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .dropzone-area:hover,
    .dropzone-area.dragover {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }

    .dropzone-area.border-danger {
        border-color: #dc3545;
        background-color: #f8d7da;
    }

    /* Стили для списка файлов */
    #fileList {
        scrollbar-width: thin;
        scrollbar-color: #adb5bd #f8f9fa;
    }

    #fileList::-webkit-scrollbar {
        width: 8px;
    }

    #fileList::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }

    #fileList::-webkit-scrollbar-thumb {
        background: #adb5bd;
        border-radius: 4px;
    }

    #fileList::-webkit-scrollbar-thumb:hover {
        background: #6c757d;
    }

    /* Анимация загрузки */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }

    /* Стили для бейджей категорий */
    .form-check-label .badge {
        font-size: 0.75em;
        min-width: 80px;
        text-align: center;
    }

    /* Адаптивные стили */
    @media (max-width: 992px) {
        .sticky-top {
            position: static !important;
        }
    }
</style>
</body>
</html>